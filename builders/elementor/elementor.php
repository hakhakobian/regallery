<?php

class REACG_Elementor extends \Elementor\Widget_Base {
  /**
   * Get widget name.
   *
   * @return string
   */
  public function get_name() {
    return 'reacg-elementor';
  }

  /**
   * Get widget title.
   *
   * @return string
   */
  public function get_title() {
    return REACG_NICENAME;
  }

  /**
   * Get widget icon.
   *
   * @return string
   */
  public function get_icon() {
    return 'reacg-elementor-icon';
  }

  /**
   * Get widget category.
   *
   * @return string[]
   */
  public function get_categories() {
    return [ 'basic' ];
  }

  /**
   * Register widget controls.
   *
   * @return void
   */
  protected function register_controls() {
    $this->start_controls_section(
      'reacg_general',
      [
        'label' => __('Basic', 'regallery'),
      ]
    );

    $edit_link = add_query_arg(array( 'post_type' => REACG_CUSTOM_POST_TYPE ), admin_url('edit.php'));
    $this->add_control(
      'post_id',
      [
        'label_block' => TRUE,
        'show_label' => FALSE,
        /* translators: 1: opening anchor tag, 2: closing anchor tag */
        'description' => sprintf(__('Add/edit galleries %1$shere%2$s.', 'regallery'), '<a target="_blank" href="' . $edit_link . '">', '</a>'),
        'type' => \Elementor\Controls_Manager::SELECT,
        'default' => 0,
        'options' => REACGLibrary::get_shortcodes(FALSE, TRUE, FALSE),
      ]
    );
    $this->add_control(
      'enable_options',
      [
        'label' => __('Enable options section', 'regallery'),
        'label_block' => FALSE,
        'type' => \Elementor\Controls_Manager::SWITCHER,
        'label_yes' => __('Yes', 'regallery'),
        'label_no' => __('No', 'regallery'),
        'default' => 'no',
        'description' => __( 'The options will be visible only in editor mode.', 'regallery' ),
      ]
    );

    $this->end_controls_section();
  }

  /**
   * Render widget output on the frontend.
   *
   * @return void
   */
  protected function render() {
    $settings = $this->get_settings_for_display();
    $post_id = intval($settings["post_id"]);

    // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped -- Intentional output of trusted HTML and JS generated by the plugin.
    echo REACGLibrary::get_rest_routs($post_id);

    if ( is_admin() ) {
      $enable_options = $settings["enable_options"] === "yes" ? 1 : 0;
      echo '<script type="text/javascript">';
      // Get inserted widget container by ID.
      echo 'var widget_cont = document.querySelector(".elementor-element-' . esc_js($this->get_id()) . '");';
      // Get the gallery container.
      echo 'var cont = widget_cont ? widget_cont.querySelector("#reacg-root' . esc_js($post_id) . '") : null;';
      // Enable/disable options section depends on Elementor widget setting.
      echo 'if (cont) {';
      echo 'cont.setAttribute("data-options-section", "' . esc_js($enable_options) . '");';
      echo 'cont.setAttribute("data-plugin-version", "' . esc_js(REACG_VERSION) . '");';
      echo 'cont.setAttribute("data-gallery-timestamp", Date.now());';
      echo 'cont.setAttribute("data-options-timestamp", Date.now());';
      echo '}';
      // Load the gallery.
      echo 'var reacgLoadApp = document.getElementById("reacg-loadApp");';
      echo 'if (reacgLoadApp) {';
      echo 'reacgLoadApp.setAttribute("data-id", "reacg-root' . esc_js($post_id) . '");';
      echo 'reacgLoadApp.click();';
      echo '}';
      // Open Elementor widget settings after the gallery load.
      echo 'if (widget_cont) { widget_cont.querySelector(".elementor-editor-widget-settings").click(); }';
      echo '</script>';
    }
  }
}
